# Codebase Structure

**Analysis Date:** 2025-02-19

## Directory Layout

```
claude-usage-widget/
├── src/                           # TypeScript source code
│   ├── main/                      # Electron main process
│   │   ├── main.ts                # Window, tray, IPC handlers
│   │   ├── preload.ts             # Sandboxed IPC bridge
│   │   └── fetch-via-window.ts    # Hidden BrowserWindow HTTP fetcher
│   ├── renderer/                  # Frontend UI (no framework)
│   │   ├── app.ts                 # UI state, login, charts
│   │   ├── index.html             # Layout, SVG icons
│   │   ├── styles.css             # Widget styling
│   │   └── env.d.ts               # Global type declarations
│   └── shared/                    # Shared types & constants
│       ├── ipc-types.ts           # TypeScript interfaces
│       ├── ipc-channels.ts        # IPC channel name constants
│       └── refresh-interval.ts    # Min/max/default refresh limits
├── dist-main/                     # Compiled main process (generated)
│   ├── main/
│   │   ├── main.js                # Compiled entry point
│   │   ├── preload.js
│   │   └── fetch-via-window.js
│   └── shared/
│       ├── ipc-types.js
│       ├── ipc-channels.js
│       └── refresh-interval.js
├── dist-renderer/                 # Bundled renderer (generated)
│   ├── index.html                 # Vite-bundled HTML
│   ├── assets/
│   └── index.js                   # Bundled app.ts + styles.css
├── assets/                        # App icons and images
│   ├── icon.icns                  # macOS app icon
│   ├── icon.ico                   # Windows app icon
│   ├── icon.png                   # Linux/generic icon
│   ├── tray-icon.png              # System tray icon
│   └── claude-logo.svg            # Logo for UI
├── package.json                   # Dependencies, build scripts, electron-builder config
├── tsconfig.json                  # Root TypeScript references
├── tsconfig.main.json             # Main process config (ES2022, CommonJS)
├── tsconfig.renderer.json         # Renderer config (ES2022, ESM)
├── vite.config.ts                 # Vite config (bundler for renderer)
├── .github/
│   └── workflows/                 # CI/CD (if present)
└── .planning/
    └── codebase/                  # Documentation (this file)
```

## Directory Purposes

**src/main/**
- Purpose: Electron main process (runs on Node.js)
- Contains: Window lifecycle, tray/menu, OS integration, IPC handlers, credential storage, API coordination
- Key files: `main.ts` (700+ lines, orchestrator), `fetch-via-window.ts` (92 lines, HTTP helper), `preload.ts` (65 lines, IPC bridge)

**src/renderer/**
- Purpose: Frontend UI (pure TypeScript, no framework)
- Contains: Login flow, progress bars, SVG countdown timers, Canvas 2D charts, event handlers, state management
- Key files: `app.ts` (1200+ lines, main UI logic), `index.html` (markup/SVG), `styles.css` (responsive widget styling), `env.d.ts` (global type stubs)

**src/shared/**
- Purpose: Shared types and constants between processes
- Contains: Credentials, UsageData, IPC channels, refresh interval bounds
- All files: Simple type/const definitions, no logic

**dist-main/**
- Purpose: Compiled main process code (generated by TypeScript compiler)
- Source: src/main + src/shared
- Output: CommonJS modules, ES2022 target, source maps included

**dist-renderer/**
- Purpose: Bundled frontend code (generated by Vite)
- Source: src/renderer, inline styles
- Output: Single HTML file + bundled JS, optimized for Chrome 120

**assets/**
- Purpose: App icons and images for packaging + UI
- icns: macOS app icon (high-res)
- ico: Windows app icon
- png: Linux/generic icon, also used as fallback/tray
- svg: Logo embedded in login screen

## Key File Locations

**Entry Points:**
- `src/main/main.ts`: Main process entry point → defines app.whenReady(), window creation, tray setup, IPC handlers
- `src/renderer/app.ts`: Renderer entry point → initializes DOM, fetches credentials, starts UI
- `src/renderer/index.html`: HTML entry loaded by Electron window or Vite dev server
- `package.json` `"main"`: Points to `dist-main/main/main.js` (compiled output)

**Configuration:**
- `package.json`: Build scripts, dependencies (only electron-store), electron-builder config
- `vite.config.ts`: Renderer bundler config, path aliases (`@shared`)
- `tsconfig.main.json`: Main process TypeScript settings (CommonJS, ES2022)
- `tsconfig.renderer.json`: Renderer TypeScript settings (ESM, ES2022)
- `src/shared/refresh-interval.ts`: User-configurable limits (1-20 min, default 5)

**Core Logic:**
- `src/main/main.ts`: Window lifecycle (create, show, hide, move), tray menu, 3x IPC handler families:
  - Credentials: GET_CREDENTIALS, SAVE_CREDENTIALS, DELETE_CREDENTIALS, VALIDATE_SESSION_KEY, DETECT_SESSION_KEY
  - Window: MINIMIZE_WINDOW, CLOSE_WINDOW, RESIZE_WINDOW, GET_WINDOW_POSITION, SET_WINDOW_POSITION
  - API: FETCH_USAGE_DATA (parallel endpoint calls), UPDATE_TRAY_USAGE (from renderer)
  - History: GET_USAGE_HISTORY, SAVE_USAGE_HISTORY_ENTRY, CLEAR_USAGE_HISTORY, GET_REFRESH_INTERVAL, SET_REFRESH_INTERVAL
- `src/renderer/app.ts`: State variables (credentials, updateInterval, latestUsageData, isExpanded, isGraphVisible), functions:
  - Login: handleAutoDetect(), handleConnect() → calls electronAPI.detectSessionKey/validateSessionKey
  - Fetch: fetchUsageData() → calls electronAPI.fetchUsageData, updates UI, saves history
  - Display: updateUI(), buildExtraRows(), updateProgressBar(), updateTimer() → renders progress bars + countdown
  - Charts: renderUsageChart() (7-day history as line chart), renderPieChart() (session + model split as donut)
  - Auto-update: startAutoUpdate(), stopAutoUpdate() → setInterval on configurable refresh rate

**Testing:**
- No test files present in codebase
- Dev testing: npm run dev (watch mode), manual interaction with widget

## Naming Conventions

**Files:**
- `camelCase.ts` for source files (e.g., `fetchViaWindow.ts`, `ipcChannels.ts`)
- `.json` for config (tsconfig, package, vite)
- `.css` for stylesheets (single file approach)
- `.html` for markup (single file)

**Directories:**
- lowercase (main, renderer, shared, assets)
- src/ for TypeScript source
- dist-* for compiled/bundled output

**Functions:**
- `camelCase` (e.g., `fetchViaWindow`, `debugLog`, `updateUI`, `startAutoUpdate`)
- Prefixes: `handle*` for event handlers, `show*/hide*` for UI state, `start*/stop*` for intervals, `render*` for charts

**Variables:**
- `camelCase` (e.g., `mainWindow`, `latestUsageData`, `isExpanded`, `credentials`)
- Prefixes: `is*` for booleans, `latest*` for cached values, `update*` for state change functions

**Types/Interfaces:**
- `PascalCase` (e.g., `Credentials`, `UsageData`, `UsageTimePeriod`, `ElectronAPI`)
- Suffix: `Result`, `Payload`, `Options` for function arguments

**IPC Channels:**
- `SCREAMING_SNAKE_CASE` constants in `ipcChannels.ts`, values are `kebab-case` strings

## Where to Add New Code

**New Feature (e.g., add CPU usage monitoring):**
- Main logic: Add to `src/main/main.ts` → new IPC handler + electron-store save
- UI display: Add to `src/renderer/app.ts` → new DOM elements in HTML, event listener, progress bar/chart
- Types: Add interface to `src/shared/ipc-types.ts` → add to ElectronAPI interface
- IPC channel: Add constant to `src/shared/ipc-channels.ts`
- Preload: Update `src/main/preload.ts` → wrap new IPC channel

**New Component/UI Section:**
- HTML markup: `src/renderer/index.html` → add div with id, follow existing structure
- CSS styling: `src/renderer/styles.css` → add class rules, use existing color/spacing variables
- TypeScript logic: `src/renderer/app.ts` → getElement() call (DOM reference), setupEventListeners() (event binding), render function if chart-based

**Utilities/Helpers:**
- New helper module: Create in `src/main/` (if main-process) or consider adding to existing file
- Shared helpers: Add to `src/shared/` (e.g., new constants file for magic numbers)
- No separate utils/ directory currently; inline in relevant process file

**API Changes (e.g., new Claude.ai endpoint):**
- Endpoint URL: `src/main/main.ts` lines 532-534 (update/add to FETCH_USAGE_DATA handler)
- Data merging: `src/main/main.ts` lines 565-596 (add Promise.allSettled result handling)
- Response type: `src/shared/ipc-types.ts` (extend UsageData interface if needed)
- UI rendering: `src/renderer/app.ts` (add to buildExtraRows or updateUI logic)

## Special Directories

**dist-main/**
- Purpose: Compiled main process code (generated)
- Generated: `npm run build:ts` via TypeScript compiler (`tsc -p tsconfig.main.json`)
- Committed: No (in .gitignore)
- Cleanup: `npm run clean` removes this directory

**dist-renderer/**
- Purpose: Bundled renderer code (generated)
- Generated: `npm run build:renderer` via Vite (`vite build`)
- Committed: No (in .gitignore)
- Cleanup: `npm run clean` removes this directory

**node_modules/**
- Purpose: Installed dependencies
- Generated: `npm install`
- Committed: No (in .gitignore)
- Minimal: Only electron-store as runtime dependency; rest are dev tools (TypeScript, Vite, Electron, electron-builder)

**assets/**
- Purpose: Static icons/images for app packaging and UI
- Committed: Yes (source images)
- Icon sizes: icon.icns (macOS), icon.ico (Windows), icon.png (Linux/general), tray-icon.png (menu bar/taskbar)
- Generate: `npm run generate-icons` (bash script using imagemagick or similar; not in current package.json)

---

*Structure analysis: 2025-02-19*
